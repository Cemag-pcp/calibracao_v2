{% extends "base.html" %}
{% load static %}

{% block links %}
    <link href="{% static 'css/timeline.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
    <h2>Plano Mestre</h2>
    <button class="btn btn-primary"><i class="fa-solid fa-plus"></i> Adicionar Instrumentos</button>
</div>

<table id="instrumentos-table" class="display table table-striped table-bordered">
    <thead>
        <tr>
            <th></th>
            <th>Tag</th>
            <th>Tipo de Instrumento</th>
            <th>Status</th>
            <th>Última Calibração</th>
            <th>Próxima Calibração</th>
            <th>Status Calibração</th>
            <th>Status Geral</th>
            <th>Responsável</th>
            <th>Ação</th>
        </tr>
    </thead>
</table>

<!-- Modal para buscar qrcode -->
<div id="modal-qrcode" class="modal fade" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-qrcode"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-qrcode" style="margin: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para buscar histórico de atualizações -->
<div id="modal-historico" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-historico"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-historico">
                <!-- A timeline será carregada dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para enviar p/ calibração -->
<div id="modal-enviar" class="modal fade" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-enviar">Enviar Instrumento para Calibração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-enviar">
                <form id="formEnviar">
                    <!-- Identificador do Instrumento -->
                    <input type="hidden" name="tag-instrumento-envio" id="tag-instrumento-envio">
                    <input type="hidden" name="pk-ponto-calibracao-enviar" id="pk-ponto-calibracao-enviar">

                    <div class="row mb-3">
                        <!-- Data de Envio -->
                        <div class="col-sm-6">
                            <label for="dataEnvio" class="form-label">Data de Envio</label>
                            <input 
                                type="date" 
                                class="form-control" 
                                name="dataEnvio" 
                                id="dataEnvio" 
                                required>
                        </div>
                        <!-- Responsável do Envio -->
                        <div class="col-sm-6">
                            <label for="responsavelEnvio" class="form-label">Responsável pelo Envio</label>
                            <select class="form-control" name="responsavelEnvio" id="responsavelEnvio" required>
                                <option value="">------------</option>
                                {% for operador in operadores %}
                                <option value="{{ operador.id }}">{{ operador.matricula }} - {{ operador.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <!-- Laboratório -->
                        <div class="col-sm-4 mb-3">
                            <label for="laboratorio" class="form-label">Laboratório</label>
                            <select class="form-control" name="laboratorio" id="laboratorio" required>
                                <option value="">------------</option>
                                {% for laboratorio in laboratorios %}
                                <option value="{{ laboratorio.id }}">{{ laboratorio.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Natureza -->
                        <div class="col-sm-4 mb-3">
                            <label for="natureza" class="form-label">Natureza</label>
                            <select class="form-control" name="natureza" id="natureza" required>
                                <option value="">------------</option>
                                {% for natureza in naturezas %}
                                <option value="{{ natureza.0 }}">{{ natureza.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Método -->
                        <div class="col-sm-4 mb-3">
                            <label for="metodo" class="form-label">Método</label>
                            <select class="form-control" name="metodo" id="metodo" required>
                                <option value="">------------</option>
                                {% for metodo in metodos %}
                                <option value="{{ metodo.0 }}">{{ metodo.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="campo-novo-instrumento">
                        <hr>
                        <p><code style="color: #001dff;" id="descricao-instrumento-substituido">Atualmente, Luan está responsável pelo instrumento. Gostaria de designar um novo instrumento para ele?</code></p>
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label for="validacao-de-substituicao" class="form-label">Instrumento será substituído?</label>
                                <select class="form-control" name="validacao-de-substituicao" id="validacao-de-substituicao" required>
                                    <option value="Não">Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>

                            <!-- Instrumento -->
                            <div class="col-sm-6 mb-3" id="col-instrumento-substituira-envio">
                                <label for="instrumento-substituira-envio" class="form-label">Instrumento</label>
                                <select class="form-control" name="instrumento-substituira-envio" id="instrumento-substituira-envio">

                                </select>
                            </div>    
                        </div>                      
                    </div>

                    <!-- Botão de Envio -->
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de recebimento de calibração -->
<div id="modal-recebimento" class="modal fade" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-recebimento">Recebimento de Calibração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-recebimento">
                <form id="formRecebimento">
                    <!-- ID do Instrumento -->
                    <input type="hidden" name="id-instrumento-recebimento" id="id-instrumento-recebimento">
                    <input type="hidden" name="pk-ponto-recebimento" id="pk-ponto-recebimento">

                    <!-- Data de Recebimento -->
                    <div class="mb-3">
                        <label for="dataRecebimento" class="form-label">Data do Recebimento</label>
                        <input 
                            type="date" 
                            class="form-control" 
                            name="dataRecebimento" 
                            id="dataRecebimento" 
                            required
                        >
                    </div>

                    <!-- Observação de Recebimento -->
                    <div class="mb-3">
                        <label for="obsRecebimento" class="form-label">Observação</label>
                        <textarea 
                            class="form-control" 
                            name="obsRecebimento" 
                            id="obsRecebimento" 
                            rows="3"
                            placeholder="Insira observações sobre o recebimento, se necessário."
                        ></textarea>
                    </div>

                    <!-- Link de Certificado -->
                    <div class="mb-3">
                        <label for="linkCertificado" class="form-label">Link do Certificado</label>
                        <input 
                            type="url" 
                            class="form-control" 
                            name="linkCertificado" 
                            id="linkCertificado" 
                            placeholder="Insira o link do certificado, se disponível."
                        >
                    </div>

                    <!-- Botão de Envio -->
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de analise da calibração -->
<div id="modal-analise" class="modal fade" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-analise"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-analise">
                <form id="formAnalise">
                    
                    <input type="hidden" name="id-instrumento-analise" id="id-instrumento-analise">
                    
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Incerteza -->
                            <label for="incertezaAnalise">Incerteza</label>
                            <input class="form-control" type="number" name="incertezaAnalise" id="incertezaAnalise" step="0.1" required>
                        </div>
                        <div class="col-sm-6">
                            <!-- Tendência -->
                            <label for="tendenciaAnalise">Tendência</label>
                            <input class="form-control" type="number" name="tendenciaAnalise" id="tendenciaAnalise" step="0.1" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Responsável pela análise -->
                            <label for="responsavelAnalise">Responsável da análise</label>
                            <select class="form-control" name="responsavelAnalise" id="responsavelAnalise" required>
                                <option value="">-------</option>
                                {% for operador in operadores %}
                                <option value="{{ operador.id }}">{{ operador.matricula }} - {{ operador.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <!-- Data da análise -->
                            <label for="dataAnalise">Data da análise</label>
                            <input class="form-control" type="date" name="dataAnalise" id="dataAnalise" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                    
                            <!-- Análise final -->
                            <label for="resultadoAnalise">Resultado final</label>
                            <select class="form-control" name="resultadoAnalise" id="resultadoAnalise" required>
                                <option value="">-------</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <!-- Informações do instrumento -->
                    <div class="text-center mb-3">
                        <h1>Informações sobre o instrumento</h1>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <p><strong>Faixa Nominal:</strong> <span id="faixaNominal"></span></p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Tolerância Admissível:</strong> <span id="toleranciaAdmissivel"></span></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <strong>Certificado:</strong>
                            <a href="#" id="certificadoAtual" target="_blank" rel="noopener noreferrer">Visualizar Certificado</a>
                        </div>
                    </div>
                    <!-- Botão de Envio -->
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-ultima-analise" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modal-title-ultima-analise" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title-ultima-analise" id="modal-title-ultima-analise">Modal Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formUltimaAnalise">
                    
                    <input type="hidden" name="id-instrumento-ultima-analise" id="id-instrumento-ultima-analise">
                    
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Incerteza -->
                            <label for="incertezaUltimaAnalise">Incerteza</label>
                            <input class="form-control" type="number" name="incertezaUltimaAnalise" id="incertezaUltimaAnalise" step="0.1" disabled>
                        </div>
                        <div class="col-sm-6">
                            <!-- Tendência -->
                            <label for="tendeciaUltimaAnalise">Tendência</label>
                            <input class="form-control" type="number" name="tendeciaUltimaAnalise" id="tendeciaUltimaAnalise" step="0.1" disabled>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Data da análise -->
                            <label for="dataUltimaAnalise">Data da análise</label>
                            <input class="form-control" type="date" name="dataUltimaAnalise" id="dataUltimaAnalise" disabled>
                        </div>
                        <div class="col-sm-6">
                    
                            <!-- Análise final -->
                            <label for="resultadoUltimaAnalise">Resultado final</label>
                            <select class="form-control" name="resultadoUltimaAnalise" id="resultadoUltimaAnalise" disabled>
                                <option value="">-------</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <!-- Informações do instrumento -->
                    <div class="text-center mb-3">
                        <h1>Informações sobre o instrumento</h1>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <p><strong>Faixa Nominal:</strong> <span id="faixaNominalUltimaAnalise"></span></p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Tolerância Admissível:</strong> <span id="toleranciaAdmissivelUltimaAnalise"></span></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-12">
                            <strong>Certificado:</strong>
                            <a href="#" id="certificadoAtualUltimaAnalise" target="_blank" rel="noopener noreferrer">Visualizar Certificado</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal p/ escolher responsável -->
<div id="modal-responsavel" class="modal fade" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-responsavel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-responsavel">
                <form id="formResponsavel">
                    <input type="hidden" name="tag-instrumento-responsavel" id="tag-instrumento-responsavel">
                    <div class="row mb-3">
                        <div class="col-sm-6 mb-3 d-none">
                            <label for="dataEntrega">Motivo</label>
                            <select class="form-control" name="motivo-responsavel" id="motivo-responsavel">
                                <option value="Entrega">-------</option>
                                {% for motivo in motivos %}
                                    <option value="{{ motivo.1 }}">{{ motivo.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <!-- Nome do responsável -->
                            <label for="nome-responsavel">Escolha um responsável</label>
                            <select class="form-control" name="nome-responsavel" id="nome-responsavel" required>
                                <option value="">-------</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <!-- Data de entrega -->
                            <label for="dataEntrega">Data da entrega</label>
                            <input class="form-control" type="date" name="dataEntrega" id="dataEntrega" required>
                        </div>
                    </div>
                    <div class="row mb-3" id="signature">
                        <label for="signature-canvas">Assinatura</label>
                        <canvas id="signature-canvas" style="border: 1px solid #000; width: 90%; height: 200px; margin: 0 auto;"></canvas>
                    </div>                  
                    <!-- Botão de Envio -->
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-secondary" id="clear-signature">Limpar Assinatura</button>
                        <div>
                            <button type="submit" class="btn btn-success">Enviar</button>
                        </div>
                    </div>
                </form>
                <div id="form-visualizar-ficha">
                    <input type="hidden" name="tag-instrumento-responsavel" id="tag-instrumento-responsavel">
                    <div class="row mb-3">
                        <div class="col-sm-6  mb-3">
                            <!-- Nome do responsável -->
                            <label for="nome-responsavel">Responsável</label>
                            <select class="form-control" name="nome-responsavel-visualizar-ficha" id="nome-responsavel-visualizar-ficha" disabled>
                                <option value="">-------</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6  mb-3">
                            <!-- Data de entrega -->
                            <label for="dataEntrega">Data da entrega</label>
                            <input class="form-control" type="date" name="dataEntrega-visualizar-ficha" id="dataEntrega-visualizar-ficha" disabled>
                        </div>
                    </div>    
                    <!-- Data de entrega -->
                    <label>Ficha</label>
                    <img id="ficha_link" src="/static/img/termo_de_responsabilidade.png" alt="Termo de Responsabilidade">           
                </div>  
            </div>
        </div>
    </div>
</div>

<div id="modal-alterar-responsavel" class="modal fade" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-alterar-responsavel">Alterar Responsável</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form-editar-responsavel">
                <div class="modal-body" id="modal-body-alterar-responsavel">
                    <input class="form-control d-none" type="text" name="nome-ultimo-responsavel" id="nome-ultimo-responsavel">
                    <input type="hidden" name="tag-instrumento-responsavel-editar" id="tag-instrumento-responsavel-editar">
                        <div class="row">
                            <div class="col-sm-6 mb-3 d-none">
                                <label for="dataEntrega">Motivo</label>
                                <select class="form-control" name="motivo-editar-responsavel" id="motivo-editar-responsavel" required>
                                    <option value="Entrega">-------</option>
                                    {% for motivo in motivos %}
                                    <option value="{{ motivo.1 }}">{{ motivo.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-6 mb-3" id="col-nome-editar-responsavel">
                                <label for="nome-responsavel">Responsável</label>
                                <select class="form-control" name="nome-editar-responsavel" id="nome-editar-responsavel">
                                    <option value="">Controle da Qualidade</option>
                                    {% for funcionario in funcionarios %}
                                    <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label for="dataEntrega" id="labelDataEntrega">Data da entrega</label>
                                <input class="form-control" type="date" name="dataEntregaEdicao" id="dataEntregaEdicao">
                            </div>
                        </div>
                        <div class="row mb-3 hide-row" id="signature-edicao">
                            <label for="signature-canvas-edicao">Assinatura</label>
                            <canvas id="signature-canvas-edicao" style="border: 1px solid #000; width: 90%; height: 200px; margin: 0 auto;"></canvas>
                        </div>   
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary hide-row" id="clear-signature-edicao">Limpar Assinatura</button>
                    <div>
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="statusInstrumentoModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="statusInstrumentoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="statusInstrumentoModalLabel"></h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="statusInstrumentoSubstituicao">
            <div class="modal-body">
                <input type="hidden" name="tag-instrumento-status-substituido" id="tag-instrumento-status-substituido">
                <input type="hidden" name="responsavel-id" id="responsavel-id">
                <div class="row mb-3 align-items-baseline">
                    <div class="col-sm-6 mb-3 col-instrumento-status-substituicao">
                        <!-- Nome do responsável -->
                        <label for="nome-status">Responsável</label>
                        <select class="form-control mb-3" name="responsavel-status-substituicao" id="responsavel-status-substituicao" disabled>
                            <option value="">-------</option>
                            {% for funcionario in funcionarios %}
                            <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-6 mb-3 col-instrumento-status-substituicao">
                        <!-- Data de entrega -->
                        <label for="instrumento-status-substituicao">Será substituido por qual instrumento?</label>
                        <select class="form-control" name="instrumento-status-substituicao" id="instrumento-status-substituicao" required>

                        </select>
                    </div>
                    <div class="col-sm-6 mb-3">
                        <!-- Data de entrega -->
                        <label for="data-substituicao">Data da substituição</label>
                        <input class="form-control" type="date" name="data-substituicao" id="data-substituicao" required>
                    </div>
                    <div class="col-sm-6 mb-3">
                        <!-- Data de entrega -->
                        <label for="dataEntrega">Motivo da substituição</label>
                        <input class="form-control" style="background-color: #e9ecef; opacity: 1;" type="text" name="instrumento-status-substituicao" id="instrumento-status-substituicao" value="Danificado" readonly>
                    </div>  
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Confirmar</button>
            </div>
        </form>
        <form class="d-none" id="statusInstrumentoDevolucao">
            <div class="modal-body">
                <div>
                    <input type="hidden" name="tag-instrumento-status" id="tag-instrumento-status">
                    <div class="row mb-3">
                        <div class="col-sm-6  mb-3">
                            <!-- Data de entrega -->
                            <label for="dataEntrega-devolver-instrumento">Data da devolução</label>
                            <input class="form-control" type="date" name="dataEntrega-devolver-instrumento" id="dataEntrega-devolver-instrumento" required>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <!-- Nome do responsável -->
                            <label for="nome-status">Responsável</label>
                            <select class="form-control" name="responsavel-status-devolucao" id="responsavel-status-devolucao" disabled>
                                <option value="">-------</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>            
                </div>  
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Confirmar</button>
            </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="{% static 'js/data-table-pc.js' %}"></script>
    <script src="{% static 'js/acoes-pc.js' %}"></script>
    <script src="{% static 'js/signature.js' %}"></script>
{% endblock %}