{% extends "base.html" %}
{% load static %}

{% block links %}
    <link href="{% static 'css/timeline.css' %}" rel="stylesheet">
    <link href="{% static 'css/selects.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
    <h2>Plano Mestre</h2>
    <button type="button" class="btn btn-primary btn-sm" id="button-modal-designarcao"><i class="fa-solid fa-plus"></i> Designar mais de um instrumento por funcionário</button>
</div>

<!-- Cards de resumo -->
<div class="row g-3 mb-4" id="cards-dashboard">
    <div class="col-6 col-lg-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="text-muted small">Em calibração</div>
                <div class="h3 mb-0" id="count-em-calibracao">—</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="text-muted small">Em uso</div>
                <div class="h3 mb-0" id="count-em-uso">—</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="text-muted small">Disponíveis</div>
                <div class="h3 mb-0" id="count-disponivel">—</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="text-muted small">Danificado</div>
                <div class="h3 mb-0" id="count-danificado">—</div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->

<div class="d-flex justify-content-end mb-4">
    <button class="btn btn-white dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
        <i class="bi bi-funnel"></i> Filtrar
    </button>
    <form id="form-filtrar-inspecao">
        <div class="dropdown-menu p-3" style="width: 500px;">
            <p class="fw-bold mx-2 my-1">Filtrar Instrumentos</p>
            <hr>
            <h6 class="mt-3">Pesquisar Tag</h6>
            <input type="text" class="form-control mb-3" id="pesquisar-tag-calibracao" placeholder="Pesquisar a tag...">

            <h6 class="mt-3">Pesquisar Tipo de Instrumento</h6>
            <input type="text" class="form-control mb-3" id="pesquisar-tipo-calibracao" placeholder="Pesquisar o instrumento...">

            <h6 class="mt-3">Intervalo de data da última calibração</h6>
            <div class="d-flex justify-content-between align-items-center">
                <input type="date" class="form-control" id="data-ultima-calibracao-inicio" style="width: 200px;">
                <span>até</span>
                <input type="date" class="form-control" id="data-ultima-calibracao-fim" style="width: 200px;">
            </div>

            <h6 class="mt-3">Intervalo de data da próxima calibração</h6>
            <div class="d-flex justify-content-between align-items-center">
                <input type="date" class="form-control" id="data-proxima-calibracao-inicio" style="width: 200px;">
                <span>até</span>
                <input type="date" class="form-control" id="data-proxima-calibracao-fim" style="width: 200px;">
            </div>

            <h6 class="mt-3">Status do Instrumento</h6>
            {% for instrumento in status_instrumento %}
                <div class="form-check">
                    <input type="checkbox" name="status_instrumento_{{instrumento.0}}" id="status_instrumento_{{instrumento.0}}" value="{{instrumento.0}}">
                    <label class="form-check-label" for="status_instrumento_{{instrumento.0}}">{{instrumento.1}}</label>
                </div>
            {% endfor %}

            <h6 class="mt-3">Status da Calibração</h6>
            {% for calibracao in status_calibracao %}
                <div class="form-check">
                    <input type="checkbox" name="status_calibracao_{{calibracao.0}}" id="status_calibracao_{{calibracao.0}}" value="{{calibracao.1}}">
                    <label class="form-check-label" for="status_calibracao_{{calibracao.0}}">{{calibracao.1}}</label>
                </div>
            {% endfor %}
    
            <div class="d-flex justify-content-between mt-3">
                <button type="button" id="btn-limpar-calibracao"  class="btn btn-outline-secondary">Limpar</button>
                <button type="button" id="btn-filtrar-calibracao" class="btn btn-dark">Filtrar</button>
            </div>
        </div>
    </form>
</div>

<div class="d-flex justify-content-end gap-2 my-2">
    <span id="qtd-pendente-calibracao" class="rounded-pill py-1 px-2" style="background-color: #ef4444; color: #fafafa; font-weight: 600; font-size: 0.75rem;"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></span>
    <span id="qtd-filtrada-calibracao" class="rounded-pill py-1 px-2" style="background-color: #f59e0b; color: #fafafa; font-weight: 600; font-size: 0.75rem; display: none;"></span>
</div>
<div class="d-flex justify-content-end flex-wrap gap-2 my-2">
    <span id="itens-filtrados-calibracao-tag" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    <span id="itens-filtrados-calibracao-tipo" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    <span id="itens-filtrados-calibracao-data-ultima" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    <span id="itens-filtrados-calibracao-data-proxima" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    <span id="itens-filtrados-calibracao-status-instrumento" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    <span id="itens-filtrados-calibracao-status-calibracao" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;"></span>
</div>

<!-- Tabs de status -->
<div class="mb-3">
    <ul class="nav nav-tabs" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-em-uso" data-type="instrumento" data-status="em_uso" type="button" role="tab" aria-selected="true">Em uso</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-disponivel" data-type="instrumento" data-status="ativo" type="button" role="tab" aria-selected="false">Disponível</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-danificado" data-type="instrumento" data-status="danificado" type="button" role="tab" aria-selected="false">Danificado</button>
        </li>
    </ul>
    <div class="tab-content pt-3" id="statusTabsContent">
        <!-- Usamos uma única tabela; as abas apenas aplicam o filtro de status -->
    </div>
    
</div>

<table id="instrumentos-table" class="display table table-striped table-bordered">
    <thead>
        <tr>
            <th></th>
            <th>Tag</th>
            <th>Tipo de Instrumento</th>
            <th>Status</th>
            <th>Última Calibração</th>
            <th>Próxima Calibração</th>
            <th>Status Calibração</th>
            <th>Status Geral</th>
            <th>Responsável</th>
            <th>Ação</th>
        </tr>
    </thead>
</table>

<!-- Modal para buscar qrcode -->
<div id="modal-qrcode" class="modal fade" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-qrcode"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-qrcode" style="margin: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para buscar histórico de atualizações -->
<div id="modal-historico" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-historico"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-historico">
                <!-- A timeline será carregada dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para enviar p/ calibração -->
<div id="modal-enviar" class="modal fade" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-enviar">Enviar Instrumento para Calibração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-enviar">
                <form id="formEnviar">
                    <!-- Identificador do Instrumento -->
                    <input type="hidden" name="tag-instrumento-envio" id="tag-instrumento-envio">
                    <input type="hidden" name="pk-ponto-calibracao-enviar" id="pk-ponto-calibracao-enviar">

                    <div class="row mb-3">
                        <!-- Data de Envio -->
                        <div class="col-sm-6">
                            <label for="dataEnvio" class="form-label">Data de Envio</label>
                            <input 
                                type="date" 
                                class="form-control" 
                                name="dataEnvio" 
                                id="dataEnvio" 
                                required>
                        </div>
                        <!-- Responsável do Envio -->
                        <div class="col-sm-6">
                            <label for="responsavelEnvio" class="form-label">Responsável pelo Envio</label>
                            <select class="form-control select2" name="responsavelEnvio" id="responsavelEnvio" required>
                                <option value="">------------</option>
                                {% for operador in operadores %}
                                <option value="{{ operador.id }}">{{ operador.matricula }} - {{ operador.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row align-items-center mb-3">
                        <!-- Laboratório -->
                        <div class="col-10 col-sm-4 mb-3">
                            <label for="laboratorio" class="form-label">Laboratório</label>
                            <select class="form-control" name="laboratorio" id="laboratorio" required>
                                <option value="">------------</option>
                                {% for laboratorio in laboratorios %}
                                <option value="{{ laboratorio.id }}">{{ laboratorio.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-1 col-sm-1 mt-3 p-0 position-relative">
                            <a class="btn btn-primary toggle-dropdown">
                                <i class="fa-solid fa-plus"></i>
                            </a>
                            <div class="dropdown-menu p-3 position-absolute translate-middle-x custom-dropdown" style="display: none; width: 250px; left: -80px">
                                <label for="">Laboratório</label>
                                <input id="input-laboratorio-instrumento" type="text" class="form-control mb-2" placeholder="Ex:. Labmetro, Instrusul ...">
                                <button type="button" id="add-novo-laboratorio" class="btn btn-success w-100">
                                    Criar novo laboratório 
                                    <span class="spinner-border spinner-border-sm" style="display: none;"></span>
                                </button>
                            </div>
                        </div>
                        <!-- Natureza -->
                        <div class="col-sm-4 mb-3">
                            <label for="natureza" class="form-label">Natureza</label>
                            <select class="form-control" name="natureza" id="natureza" required>
                                <option value="">------------</option>
                                {% for natureza in naturezas %}
                                <option value="{{ natureza.0 }}">{{ natureza.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Método -->
                        <div class="col-sm-3 mb-3">
                            <label for="metodo" class="form-label">Método</label>
                            <select class="form-control" name="metodo" id="metodo" required>
                                <option value="">------------</option>
                                {% for metodo in metodos %}
                                <option value="{{ metodo.0 }}">{{ metodo.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="campo-novo-instrumento">
                        <hr>
                        <p><code style="color: #001dff;" id="descricao-instrumento-substituido"></code></p>
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label for="validacao-de-substituicao" class="form-label">Instrumento será substituído?</label>
                                <select class="form-control" name="validacao-de-substituicao" id="validacao-de-substituicao" required>
                                    <option value="Não">Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>

                            <!-- Instrumento -->
                            <div class="col-sm-6 mb-3" id="col-instrumento-substituira-envio">
                                <label for="instrumento-substituira-envio" class="form-label">Instrumento</label>
                                <select class="form-control select2" name="instrumento-substituira-envio" id="instrumento-substituira-envio">

                                </select>
                            </div>    
                        </div>                      
                    </div>

                    <!-- Botão de Envio -->
                    <div class="modal-footer">
                        <button id="submit-enviar-instrumento" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                            <span>Enviar</span>
                            <span class="spinner-border spinner-border-sm" id="spinner-enviar-instrumento" style="display: none;"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de recebimento de calibração -->
<div id="modal-recebimento" class="modal fade" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-recebimento">Recebimento de Calibração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-recebimento">
                <form id="formRecebimento">
                    <!-- ID do Instrumento -->
                    <input type="hidden" name="id-instrumento-recebimento" id="id-instrumento-recebimento">
                    <input type="hidden" name="pk-ponto-recebimento" id="pk-ponto-recebimento">

                    <!-- Data de Recebimento -->
                    <div class="mb-3">
                        <label for="dataRecebimento" class="form-label">Data do Recebimento</label>
                        <input 
                            type="date" 
                            class="form-control" 
                            name="dataRecebimento" 
                            id="dataRecebimento" 
                            required>
                    </div>

                    <!-- Observação de Recebimento -->
                    <div class="mb-3">
                        <label for="obsRecebimento" class="form-label">Observação</label>
                        <textarea 
                            class="form-control" 
                            name="obsRecebimento" 
                            id="obsRecebimento" 
                            rows="3"
                            placeholder="Insira observações sobre o recebimento, se necessário."></textarea>
                    </div>

                    <!-- Link de Certificado -->
                    <div class="mb-3">
                        <label for="linkCertificado" class="form-label">Link do Certificado</label>
                        <input 
                            type="url" 
                            class="form-control" 
                            name="linkCertificado" 
                            id="linkCertificado" 
                            placeholder="Insira o link do certificado, se disponível.">
                    </div>

                    <div id="campo-ultimo-assinante" style="display: none;">
                        <hr>
                        <p><code style="color: #001dff;" id="descricao-ultimo-assinante">A última assinatura foi feita pelo ..., deseja devolver o instrumento novamente?</code></p>                     
                    </div>

                    <!-- Botão de Envio -->
                    <div class="modal-footer">
                        <button id="submit-receber-instrumento" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                            <span>Receber</span>
                            <span class="spinner-border spinner-border-sm" id="spinner-receber-instrumento" style="display: none;"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de analise da calibração -->
<div id="modal-analise" class="modal fade" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-analise"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-analise">
                <form id="formAnalise">
                    
                    <input type="hidden" name="id-instrumento-analise" id="id-instrumento-analise">
                    
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Incerteza -->
                            <label for="incertezaAnalise">Incerteza</label>
                            <input class="form-control" type="number" name="incertezaAnalise" id="incertezaAnalise" step="0.00001" required>
                        </div>
                        <div class="col-sm-6">
                            <!-- Tendência -->
                            <label for="tendenciaAnalise">Tendência</label>
                            <input class="form-control" type="number" name="tendenciaAnalise" id="tendenciaAnalise" step="0.00001" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Responsável pela análise -->
                            <label for="responsavelAnalise">Responsável da análise</label>
                            <select class="form-control select2" name="responsavelAnalise" id="responsavelAnalise" required>
                                <option value="">-------</option>
                                {% for operador in operadores %}
                                <option value="{{ operador.id }}">{{ operador.matricula }} - {{ operador.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <!-- Data da análise -->
                            <label for="dataAnalise">Data da análise</label>
                            <input class="form-control" type="date" name="dataAnalise" id="dataAnalise" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                    
                            <!-- Análise final -->
                            <label for="resultadoAnalise">Resultado final</label>
                            <select class="form-control" name="resultadoAnalise" id="resultadoAnalise" required>
                                <option value="">-------</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <!-- Informações do instrumento -->
                    <div class="text-center mb-3">
                        <h1>Informações sobre o instrumento</h1>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <p><strong>Faixa Nominal:</strong> <span id="faixaNominal"></span></p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Tolerância Admissível:</strong> <span id="toleranciaAdmissivel"></span></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <strong>Certificado:</strong>
                            <div class="d-flex gap-2 align-items-center">
                                <a href="#" id="certificadoAtual" target="_blank" rel="noopener noreferrer">Visualizar Certificado</a>
                                <input class="form-control" type="text" id="inputCertificadoAtual" style="display: none;">
                                <i id="editCertificadoAtual" class="bi bi-pencil-square" style="font-size: 20px; cursor: pointer;"></i>
                                <div id="actionButtons" style="display: none;">
                                    <i id="confirmEdit" class="bi bi-check-circle-fill text-success" style="font-size: 20px; cursor: pointer; padding: 10px;"></i>
                                    <i id="cancelEdit" class="bi bi-x-circle-fill text-danger" style="font-size: 20px; cursor: pointer; padding: 10px"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Botão de Envio -->
                    <div class="modal-footer">
                        <button id="submit-analisar-instrumento" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                            <span>Analisar</span>
                            <span class="spinner-border spinner-border-sm" id="spinner-analisar-instrumento" style="display: none;"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-ultima-analise" data-id="" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modal-title-ultima-analise">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title-ultima-analise" id="modal-title-ultima-analise">Modal Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formUltimaAnalise">
            <div class="modal-body">
                    
                    <input type="hidden" name="id-instrumento-ultima-analise" id="id-instrumento-ultima-analise">
                    
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Incerteza -->
                            <label for="incertezaUltimaAnalise">Incerteza</label>
                            <input class="form-control" type="number" name="incertezaUltimaAnalise" id="incertezaUltimaAnalise" step="0.00001" required>
                        </div>
                        <div class="col-sm-6">
                            <!-- Tendência -->
                            <label for="tendeciaUltimaAnalise">Tendência</label>
                            <input class="form-control" type="number" name="tendeciaUltimaAnalise" id="tendeciaUltimaAnalise" step="0.00001"required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <!-- Data da análise -->
                            <label for="dataUltimaAnalise">Data da análise</label>
                            <input class="form-control" type="date" name="dataUltimaAnalise" id="dataUltimaAnalise" disabled>
                        </div>
                        <div class="col-sm-6">
                    
                            <!-- Análise final -->
                            <label for="resultadoUltimaAnalise">Resultado final</label>
                            <select class="form-control" name="resultadoUltimaAnalise" id="resultadoUltimaAnalise" required>
                                <option value="">-------</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label for="unidadeUltimaAnalise">Unidade</label>
                            <input class="form-control" type="text" name="unidadeUltimaAnalise" id="unidadeUltimaAnalise" disabled>
                        </div>
                    </div>
                    <hr>
                    <!-- Informações do instrumento -->
                    <div class="text-center mb-3">
                        <h1>Informações sobre o instrumento</h1>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <p><strong>Faixa Nominal:</strong> <span id="faixaNominalUltimaAnalise"></span></p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Tolerância Admissível:</strong> <span id="toleranciaAdmissivelUltimaAnalise"></span></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-12">
                            <strong>Certificado:</strong>
                            <div class="d-flex gap-2 align-items-center">
                                <a href="#" id="certificadoAtualUltimaAnalise" target="_blank" rel="noopener noreferrer">Visualizar Certificado</a>
                                <input class="form-control" type="text" id="inputCertificadoAtualUltimaAnalise" style="display: none;">
                                <i id="editCertificadoAtualUltimaAnalise" class="bi bi-pencil-square" style="font-size: 20px; cursor: pointer;"></i>
                                <div id="actionButtonsUltimaAnalise" style="display: none;">
                                    <i id="confirmEditUltimaAnalise" class="bi bi-check-circle-fill text-success" style="font-size: 20px; cursor: pointer; padding: 10px;"></i>
                                    <i id="cancelEditUltimaAnalise" class="bi bi-x-circle-fill text-danger" style="font-size: 20px; cursor: pointer; padding: 10px"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="submit-ultima-analise" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                        <span>Editar</span>
                        <span class="spinner-border spinner-border-sm" id="spinner-ultima-analise" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal p/ escolher responsável -->
<div id="modal-responsavel" class="modal fade" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-responsavel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-responsavel">
                <form id="formResponsavel">
                    <input type="hidden" name="tag-instrumento-responsavel" id="tag-instrumento-responsavel">
                    <div class="row mb-3">
                        <div class="col-sm-6 mb-3 d-none">
                            <label for="dataEntrega">Motivo</label>
                            <select class="form-control" name="motivo-responsavel" id="motivo-responsavel">
                                <option value="Entrega">-------</option>
                                {% for motivo in motivos %}
                                    <option value="{{ motivo.1 }}">{{ motivo.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <!-- Nome do responsável -->
                            <label for="nome-responsavel">Escolha um responsável</label>
                            <select class="form-control select2" name="nome-responsavel" id="nome-responsavel" required>
                                <option value="">-------</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <!-- Data de entrega -->
                            <label for="dataEntrega">Data da entrega</label>
                            <input class="form-control" type="date" name="dataEntrega" id="dataEntrega" required>
                        </div>
                    </div>
                    <div class="row mb-3" id="signature">
                        <label for="signature-canvas">Assinatura</label>
                        <canvas id="signature-canvas" style="border: 1px solid #000; width: 90%; height: 200px; margin: 0 auto;"></canvas>
                    </div>                  
                    <!-- Botão de Envio -->
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-secondary" id="clear-signature">Limpar Assinatura</button>
                        <div>
                            <button id="submit-atribuir-instrumento-responsavel" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                                <span>Enviar</span>
                                <span class="spinner-border spinner-border-sm" id="spinner-atribuir-instrumento-responsavel" style="display: none;"></span>
                            </button>
                        </div>
                    </div>
                </form>
                <div id="form-visualizar-ficha">
                    <input type="hidden" name="tag-instrumento-responsavel" id="tag-instrumento-responsavel">
                    <div class="row mb-3">
                        <div class="col-sm-6  mb-3">
                            <!-- Nome do responsável -->
                            <label for="nome-responsavel">Responsável</label>
                            <select class="form-control" name="nome-responsavel-visualizar-ficha" id="nome-responsavel-visualizar-ficha" disabled>
                                <option value="">-------</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6  mb-3">
                            <!-- Data de entrega -->
                            <label for="dataEntrega">Data da entrega</label>
                            <input class="form-control" type="date" name="dataEntrega-visualizar-ficha" id="dataEntrega-visualizar-ficha" disabled>
                        </div>
                    </div>    
                    <!-- Data de entrega -->
                    <!-- <label>Ficha</label>
                    <img id="ficha_link" src="/static/img/termo_de_responsabilidade.png" alt="Termo de Responsabilidade">            -->
                </div>  
            </div>
        </div>
    </div>
</div>

<div id="modal-alterar-responsavel" class="modal fade" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title-alterar-responsavel">Alterar Responsável</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form-editar-responsavel">
                <div class="modal-body" id="modal-body-alterar-responsavel">
                    <input class="form-control d-none" type="text" name="nome-ultimo-responsavel" id="nome-ultimo-responsavel">
                    <input type="hidden" name="tag-instrumento-responsavel-editar" id="tag-instrumento-responsavel-editar">
                        <div class="row">
                            <div class="col-sm-6 mb-3 d-none">
                                <label for="dataEntrega">Motivo</label>
                                <select class="form-control" name="motivo-editar-responsavel" id="motivo-editar-responsavel" required>
                                    <option value="Entrega">-------</option>
                                    {% for motivo in motivos %}
                                    <option value="{{ motivo.1 }}">{{ motivo.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-6 mb-3" id="col-nome-editar-responsavel">
                                <label for="nome-responsavel">Responsável</label>
                                <select class="form-control select2" name="nome-editar-responsavel" id="nome-editar-responsavel">
                                    <option value="">Controle da Qualidade</option>
                                    {% for funcionario in funcionarios %}
                                    <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label for="dataEntrega" id="labelDataEntrega">Data da entrega</label>
                                <input class="form-control" type="date" name="dataEntregaEdicao" id="dataEntregaEdicao">
                            </div>
                        </div>
                        <div class="row mb-3 hide-row" id="signature-edicao">
                            <label for="signature-canvas-edicao">Assinatura</label>
                            <canvas id="signature-canvas-edicao" style="border: 1px solid #000; width: 90%; height: 200px; margin: 0 auto;"></canvas>
                        </div>   
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary hide-row" id="clear-signature-edicao">Limpar Assinatura</button>
                    <div>
                        <button id="submit-alterar-instrumento-responsavel" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                            <span>Enviar</span>
                            <span class="spinner-border spinner-border-sm" id="spinner-alterar-instrumento-responsavel" style="display: none;"></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="statusInstrumentoModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="statusInstrumentoModalLabel">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="statusInstrumentoModalLabel"></h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="statusInstrumentoSubstituicao">
            <div class="modal-body">
                <input type="hidden" name="tag-instrumento-status-substituido" id="tag-instrumento-status-substituido">
                <input type="hidden" name="responsavel-id" id="responsavel-id">
                <div class="row mb-3 align-items-baseline">
                    <div class="col-sm-6 mb-3 col-instrumento-status-substituicao">
                        <!-- Nome do responsável -->
                        <label for="nome-status">Responsável</label>
                        <select class="form-control mb-3" name="responsavel-status-substituicao" id="responsavel-status-substituicao" disabled>
                            <option value="">-------</option>
                            {% for funcionario in funcionarios %}
                            <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-6 mb-3 col-instrumento-status-substituicao">
                        <label for="instrumento-status-substituicao">Será substituido por qual instrumento?</label>
                        <select class="form-control select2" name="instrumento-status-substituicao" id="instrumento-status-substituicao">

                        </select>
                    </div>
                    <div class="col-sm-6 mb-3">
                        <label for="data-substituicao">Data da substituição</label>
                        <input class="form-control" type="date" name="data-substituicao" id="data-substituicao" required>
                    </div>
                    <div class="col-sm-6 mb-3">
                        <label for="dataEntrega">Motivo da substituição</label>
                        <input class="form-control" style="background-color: #e9ecef; opacity: 1;" type="text" name="instrumento-status-substituicao" id="instrumento-status-substituicao" value="Danificado" readonly>
                    </div>  
                </div>
            </div>
            <div class="modal-footer">
                <div>
                    <button id="submit-substituicao-instrumento" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                        <span>Confirmar</span>
                        <span class="spinner-border spinner-border-sm" id="spinner-substituicao-instrumento" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </form>
        <form class="d-none" id="statusInstrumentoDevolucao">
            <div class="modal-body">
                <div>
                    <input type="hidden" name="tag-instrumento-status" id="tag-instrumento-status">
                    <div class="row mb-3">
                        <div class="col-sm-6  mb-3">
                            <!-- Data de entrega -->
                            <label for="dataEntrega-devolver-instrumento">Data da devolução</label>
                            <input class="form-control" type="date" name="dataEntrega-devolver-instrumento" id="dataEntrega-devolver-instrumento" required>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <!-- Nome do responsável -->
                            <label for="nome-status">Responsável</label>
                            <select class="form-control" name="responsavel-status-devolucao" id="responsavel-status-devolucao" disabled>
                                <option value="">-------</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>            
                </div>  
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Confirmar</button>
                <div>
                    <button id="submit-substituicao-instrumento" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                        <span>Enviar</span>
                        <span class="spinner-border spinner-border-sm" id="spinner-substituicao-instrumento" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </form>
      </div>
    </div>
  </div>

<div class="modal fade" id="modalDesignarMaisDeUmInstrumento" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="designarMaisDeUmInstrumentoLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="designarMaisDeUmInstrumentoLabel">Designar mais de um instrumento por funcionário</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form-designar-varios-instrumentos">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label for="">Funcionário</label>
                            <select class="form-control select2" name="funcionario-designar-varios-instrumentos" id="funcionario-designar-varios-instrumentos" required>
                                <option value="">Selecione um funcionário</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{funcionario.id}}">{{funcionario.matricula}} - {{funcionario.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label for="data-designar-varios-instrumentos">Data Entrega</label>
                            <input class="form-control" type="datetime-local" name="data-designar-varios-instrumentos" id="data-designar-varios-instrumentos" required>
                        </div>
                    </div>
                    <div class="row mb-3 designar-varios-instrumentos">
                        <div class="col-sm-12">
                            <label for="instrumento-designado">Instrumento</label>
                            <select class="form-control instrumento-designado" required>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-12 mb-4" id="add_remove_cause" style="display: flex;justify-content: space-between; align-items: center;">
                        <a class="btn btn-danger" id="removeButton" style="font-size: 10px;" disabled>Remover instrumento</a>
                        <a class="btn btn-primary" id="addButton" style="font-size: 10px;">Adicionar instrumento</a>
                    </div>
                    <div class="row mb-3" id="signature-add-instrumentos">
                        <label for="signature-canvas-designar-varios-instrumentos">Assinatura</label>
                        <canvas id="signature-canvas-designar-varios-instrumentos" style="border: 1px solid #000; width: 90%; height: 200px; margin: 0 auto;"></canvas>
                    </div>   
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <a class="btn btn-secondary" id="clear-signature-add-instrumentos">Limpar Assinatura</a>
                    <button id="submit-designar-mais-instrumento-responsavel" type="submit" class="btn btn-success d-flex align-items-center gap-2">
                        <span>Confirmar</span>
                        <span class="spinner-border spinner-border-sm" id="spinner-designar-mais-instrumento-responsavel" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="{% static 'js/data-table-pc.js' %}"></script>
    <script src="{% static 'js/acoes-pc.js' %}"></script>
    <script src="{% static 'js/signature.js' %}"></script>
    <script src="{% static 'js/select2.js' %}"></script>
    <script src="{% static 'js/add-varios-instrumentos.js' %}"></script>
    <script src="{% static 'js/designar-mais-instrumentos.js' %}"></script>
    <script src="{% static 'js/crud/dropdown.js' %}"></script>
    <script src="{% static 'js/crud/add-laboratorio.js' %}"></script>
    <script src="{% static 'js/crud/editar-ultima-analise.js' %}"></script>
    <script src="{% static 'js/crud/editar-certificado.js' %}"></script>
    <script src="{% static 'js/crud/editar-certificado-ultima-analise.js' %}"></script>

    <script>
        // Controla a troca de abas aplicando o filtro de status do instrumento
        function setStatusTab(status) {
            // Desmarca todos os status do instrumento
            $("input[name^='status_instrumento_']").prop('checked', false);

            // Marca o status correspondente à aba
            const $cb = $("#status_instrumento_" + status);
            if ($cb.length) {
                $cb.prop('checked', true);
            }

            // Recarrega a tabela já existente (definida em data-table-pc.js)
            if (typeof table !== 'undefined') {
                table.ajax.reload();
            }

            // Atualiza os chips de filtros aplicados, se a função existir
            if (typeof atualizarFiltrosAplicados === 'function') {
                atualizarFiltrosAplicados();
            }
        }

        // Busca contadores e atualiza os cards
        function carregarContadores() {
            fetch('/dashboard-counts/')
                .then(resp => resp.json())
                .then(data => {
                    if (data) {
                        document.getElementById('count-em-calibracao').innerText = data.em_calibracao ?? 0;
                        document.getElementById('count-em-uso').innerText = data.em_uso ?? 0;
                        document.getElementById('count-disponivel').innerText = data.disponivel ?? 0;
                        document.getElementById('count-danificado').innerText = data.danificado ?? 0;
                    }
                })
                .catch(() => {
                    // Em caso de erro, mantem traço
                });
        }

        $(function () {
            // Inicializa com a aba "Em uso"
            setStatusTab('em_uso', 'instrumento');
            // Carrega os contadores dos cards
            carregarContadores();

            // Clique nas abas
            $('#statusTabs .nav-link').on('click', function () {
                $('#statusTabs .nav-link').removeClass('active');
                $(this).addClass('active');
                const status = $(this).data('status');
                const type = $(this).data('type') || 'instrumento';
                if (type === 'calibracao') {
                    $("input[name^='status_instrumento_']").prop('checked', false);
                    $("input[name^='status_calibracao_']").prop('checked', false);
                    const $cbCal = $("#status_calibracao_" + status);
                    if ($cbCal.length) { $cbCal.prop('checked', true); }
                    if (typeof table !== 'undefined') { table.ajax.reload(); }
                    if (typeof atualizarFiltrosAplicados === 'function') { atualizarFiltrosAplicados(); }
                    return;
                }
                setStatusTab(status, type);
            });

            // Quando o usuário limpar os filtros, mantenha o status da aba atual
            $('#btn-limpar-calibracao').on('click', function () {
                const activeStatus = $('#statusTabs .nav-link.active').data('status');
                // Aguarda a limpeza padrão e reaplica o status da aba
                setTimeout(function(){ setStatusTab(activeStatus, activeType); }, 0);
            });
        });
    </script>

    <script>
        // Override do comportamento do botão Limpar para manter a aba ativa
        $(function(){
            $('#btn-limpar-calibracao').off('click').on('click', function () {
                const $active = $('#statusTabs .nav-link.active');
                const activeStatus = $active.data('status');
                const activeType = $active.data('type') || 'instrumento';
                setTimeout(function(){
                    if (activeType === 'calibracao') {
                        $("input[name^='status_instrumento_']").prop('checked', false);
                        $("input[name^='status_calibracao_']").prop('checked', false);
                        const $cbCal = $("#status_calibracao_" + activeStatus);
                        if ($cbCal.length) { $cbCal.prop('checked', true); }
                        if (typeof table !== 'undefined') { table.ajax.reload(); }
                        if (typeof atualizarFiltrosAplicados === 'function') { atualizarFiltrosAplicados(); }
                    } else {
                        setStatusTab(activeStatus, activeType);
                    }
                }, 0);
            });
        });
    </script>

{% endblock %}
